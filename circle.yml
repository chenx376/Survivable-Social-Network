machine:
  environment:
    PATH: ${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin
    NODE_ENV: test
  node:
    version: 7.5.0

dependencies:
  pre:
    - npm install -g  gulp
    - npm install -g mocha
    - npm install:
        pwd: sv4-esn-services/
    - heroku create --ssh-git
    - git config --global url.ssh://git@heroku.com/.insteadOf https://git.heroku.com/
    - git remote add sv4-esn-services-heroku git@heroku.com:sv4-esn-services.git
    - git remote add sv4-esn-view-heroku git@heroku.com:sv4-esn-view.git
test:
  override:
    - gulp test:
        pwd: sv4-esn-services
    - if [[ -e test-results.xml ]]; then cp test-results.xml $CIRCLE_TEST_REPORTS/test-results.xml; fi:
        pwd: sv4-esn-services

deployment:
  prod:
    branch: production
    commands:
      - |
	cat >~/.netrc <<EOF
            machine api.heroku.com
                login $HEROKU_EMAIL
                password $HEROKU_TOKEN
            machine git.heroku.com
                login $HEROKU_EMAIL
                password $HEROKU_TOKEN
	EOF
      - chmod 600 ~/.netrc # Heroku cli complains about permissions without this
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git subtree push --prefix sv4-esn-services sv4-esn-services-heroku production
      - git subtree push --prefix sv4-esn-view sv4-esn-view-heroku production
